rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------- Helpers --------
    function signedIn() {
      return request.auth != null;
    }

    function uid() {
      return request.auth.uid;
    }

    function isAdmin() {
      return signedIn()
        && get(/databases/$(database)/documents/users/$(uid())).data.role == 'admin';
    }

    function isChatParticipantByResource() {
      return signedIn()
        && resource.data.participants is list
        && uid() in resource.data.participants;
    }

    // ---------- USERS ----------
    match /users/{userId} {
      allow create: if signedIn() && userId == uid();
      allow read: if (signedIn() && userId == uid()) || isAdmin();
      allow update: if (signedIn() && userId == uid()) || isAdmin();
      allow delete: if false;

      match /favorites/{favId} {
        allow read, create, update, delete: if signedIn() && userId == uid();
      }
    }

    // ---------- PRODUCTS ----------
    match /products/{id} {
      allow read: if signedIn();

      allow create: if signedIn()
        && request.resource.data.ownerId == uid();

      allow update: if signedIn() && (
        (resource.data.ownerId == uid()
          && request.resource.data.ownerId == resource.data.ownerId)
        || isAdmin()
      );

      allow delete: if (signedIn() && resource.data.ownerId == uid()) || isAdmin();
    }

    // ---------- EXCHANGE POSTS ----------
    match /exchange_posts/{id} {
      allow read: if signedIn();

      allow create: if signedIn()
        && request.resource.data.ownerId == uid();

      allow update: if signedIn() && (
        (resource.data.ownerId == uid()
          && request.resource.data.ownerId == resource.data.ownerId)
        || isAdmin()
      );

      allow delete: if (signedIn() && resource.data.ownerId == uid()) || isAdmin();
    }

    // ---------- EXCHANGES  ----------
    match /exchanges/{id} {

      // requester OR owner can read their exchanges
      allow read: if signedIn()
        && (
          resource.data.requesterId == uid()
          || resource.data.ownerId == uid()
          || isAdmin()
        );

      // requester creates exchange
      allow create: if signedIn()
        && request.resource.data.requesterId == uid();

      // requester or owner can update status
      allow update: if signedIn()
        && (
          resource.data.requesterId == uid()
          || resource.data.ownerId == uid()
          || isAdmin()
        );

      allow delete: if false;
    }

    // ---------- PROMOTIONS ----------
    match /promotions/{id} {
      allow read: if isAdmin()
        || (signedIn() && resource.data.isApproved == true);

      allow create: if signedIn()
        && request.resource.data.ownerId == uid()
        && request.resource.data.isApproved == false
        && request.resource.data.status == 'pending';

      allow update: if signedIn() && (
        (resource.data.ownerId == uid()
          && request.resource.data.ownerId == resource.data.ownerId
          && request.resource.data.isApproved == resource.data.isApproved)
        || isAdmin()
      );

      allow delete: if (signedIn() && resource.data.ownerId == uid()) || isAdmin();
    }

    // ---------- REPORTS ----------
    match /reports/{id} {
      allow create: if signedIn()
        && request.resource.data.reporterId == uid()
        && request.resource.data.status == 'pending';

      allow read, update, delete: if isAdmin();
    }

    // ---------- CHATS ----------
    match /chats/{chatId} {

      // REQUIRED for chat list queries
      allow list: if signedIn();

      // Only participants can read the chat document
      allow read: if isChatParticipantByResource();

      allow create: if signedIn()
        && request.resource.data.participants is list
        && request.resource.data.participants.size() == 2
        && uid() in request.resource.data.participants;

      allow update: if isChatParticipantByResource();
      allow delete: if false;

      match /messages/{msgId} {
        allow read: if signedIn()
          && uid() in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;

        allow create: if signedIn()
          && uid() in get(/databases/$(database)/documents/chats/$(chatId)).data.participants
          && request.resource.data.senderId == uid()
          && request.resource.data.type in ['text','image'];

        allow update: if false;
        allow delete: if false;
      }
    }
  }
}
